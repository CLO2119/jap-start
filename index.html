<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ—¥èªèµ·æ­¥èµ° Jap Start 3.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
--bg: #f5f7fb;
--primary: #ff6b6b;
--primary-dark: #e05656;
--accent: #4dabf7;
--text-main: #222;
--text-sub: #555;
--card-bg: #ffffff;
--border: #dde2f0;
--radius: 12px;
--shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
}

* {
box-sizing: border-box;
}

body {
margin: 0;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
sans-serif;
background: radial-gradient(circle at top left, #ffe6e6, #f5f7fb 40%, #e3f2ff);
color: var(--text-main);
}

.app-shell {
max-width: 1100px;
margin: 0 auto;
padding: 16px 16px 40px;
}

header {
text-align: center;
margin-bottom: 18px;
}

header h1 {
font-size: 2rem;
margin: 6px 0;
}

header h1 span {
font-size: 1rem;
font-weight: 500;
color: var(--primary);
margin-left: 6px;
}

header p {
margin: 4px 0;
color: var(--text-sub);
font-size: 0.95rem;
}

.tagline {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 4px 10px;
border-radius: 999px;
background: rgba(255, 255, 255, 0.8);
border: 1px solid rgba(255, 107, 107, 0.15);
font-size: 0.8rem;
color: var(--primary-dark);
margin-bottom: 4px;
}

.layout {
display: flex;
flex-direction: column;
gap: 16px;
}

@media (min-width: 768px) {
.layout {
flex-direction: row;
align-items: flex-start;
}
}

.panel {
background: var(--card-bg);
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 16px;
border: 1px solid rgba(148, 163, 184, 0.24);
}

.panel-main {
flex: 3;
min-width: 0;
}

.panel-quiz {
flex: 2;
min-width: 0;
}

.tabs {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin-bottom: 10px;
}

.tab-btn {
flex: 1 1 120px;
border-radius: 999px;
border: 1px solid var(--border);
padding: 6px 10px;
background: #f8fafc;
font-size: 0.9rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
gap: 6px;
transition: background 0.15s, color 0.15s, border-color 0.15s,
transform 0.05s;
white-space: nowrap;
}

.tab-btn span.en {
font-size: 0.7rem;
color: var(--text-sub);
}

.tab-btn.active {
background: linear-gradient(135deg, #ff6b6b, #ffa94d);
color: white;
border-color: transparent;
transform: translateY(-1px);
}

.tab-btn.active span.en {
color: rgba(255, 255, 255, 0.9);
}

.list-header {
display: flex;
justify-content: space-between;
align-items: baseline;
margin-bottom: 6px;
}

.list-header h2 {
font-size: 1rem;
margin: 0;
}

.list-header small {
color: var(--text-sub);
font-size: 0.8rem;
}

.entry-list {
max-height: 360px;
overflow-y: auto;
padding-right: 4px;
border-top: 1px solid var(--border);
margin-top: 8px;
}

.entry {
display: grid;
grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr) minmax(0, 1.3fr) auto auto;
gap: 6px;
padding: 8px 0;
border-bottom: 1px dashed #e2e8f0;
align-items: center;
font-size: 0.9rem;
}

.entry-main {
font-weight: 600;
font-size: 1rem;
}

.entry span.sub {
color: var(--text-sub);
font-size: 0.8rem;
}

.speak-btn,
.fav-btn {
border-radius: 999px;
border: none;
padding: 4px 10px;
font-size: 0.8rem;
cursor: pointer;
background: #e7f5ff;
display: inline-flex;
align-items: center;
gap: 4px;
transition: background 0.15s, transform 0.05s;
white-space: nowrap;
}

.speak-btn:hover,
.fav-btn:hover {
background: #d0ebff;
transform: translateY(-1px);
}

.fav-btn.favorited {
background: #fff3bf;
}

.badge {
display: inline-flex;
align-items: center;
gap: 4px;
padding: 2px 8px;
border-radius: 999px;
background: #f1f5f9;
color: #64748b;
font-size: 0.75rem;
}

.support-warning {
margin-top: 6px;
font-size: 0.8rem;
color: #b91c1c;
}

.empty-hint {
padding: 10px 4px;
font-size: 0.85rem;
color: #64748b;
}

/* Quiz panel */
.panel-quiz h2 {
font-size: 1rem;
margin-top: 0;
margin-bottom: 6px;
}

.quiz-controls {
display: flex;
flex-wrap: wrap;
gap: 8px;
margin-bottom: 10px;
align-items: center;
}

.quiz-select {
flex: 1 1 120px;
padding: 6px 8px;
border-radius: 999px;
border: 1px solid var(--border);
background: #f8fafc;
font-size: 0.85rem;
}

.quiz-mode-toggle {
display: flex;
gap: 6px;
flex: 1 1 100%;
}

.pill-btn {
flex: 1;
padding: 6px 8px;
border-radius: 999px;
border: 1px solid var(--border);
background: #f8fafc;
font-size: 0.8rem;
cursor: pointer;
transition: background 0.15s, border-color 0.15s;
}

.pill-btn.active {
background: rgba(77, 171, 247, 0.1);
border-color: var(--accent);
color: #1d4ed8;
}

.btn-primary {
border-radius: 999px;
border: none;
padding: 8px 14px;
background: var(--primary);
color: white;
font-size: 0.9rem;
cursor: pointer;
display: inline-flex;
align-items: center;
gap: 6px;
transition: background 0.15s, transform 0.05s, box-shadow 0.1s;
box-shadow: 0 4px 10px rgba(248, 113, 113, 0.4);
margin-left: auto;
}

.btn-primary:hover {
background: var(--primary-dark);
transform: translateY(-1px);
box-shadow: 0 6px 14px rgba(248, 113, 113, 0.35);
}

.btn-primary:active {
transform: translateY(0);
box-shadow: 0 3px 8px rgba(248, 113, 113, 0.3);
}

.quiz-card {
margin-top: 8px;
border-radius: 10px;
border: 1px solid var(--border);
padding: 10px;
background: #f8fafc;
font-size: 0.95rem;
}

.quiz-meta {
display: flex;
justify-content: space-between;
font-size: 0.8rem;
color: var(--text-sub);
margin-bottom: 6px;
flex-wrap: wrap;
gap: 4px;
}

.quiz-question-label {
font-size: 0.8rem;
text-transform: uppercase;
letter-spacing: 0.05em;
color: #64748b;
margin-bottom: 4px;
}

.quiz-question-main {
font-size: 1.05rem;
font-weight: 600;
margin-bottom: 6px;
}

.progress-wrap {
margin-bottom: 6px;
}

.progress-text {
font-size: 0.75rem;
color: #64748b;
margin-bottom: 2px;
display: flex;
justify-content: space-between;
}

.progress-bar {
width: 100%;
height: 6px;
border-radius: 999px;
background: #e2e8f0;
overflow: hidden;
}

.progress-inner {
height: 100%;
width: 0%;
border-radius: inherit;
background: linear-gradient(90deg, #4dabf7, #ff6b6b);
transition: width 0.2s ease-out;
}

.quiz-options {
display: grid;
grid-template-columns: 1fr;
gap: 6px;
margin-top: 4px;
}

@media (min-width: 480px) {
.quiz-options {
grid-template-columns: 1fr 1fr;
}
}

.quiz-option {
border-radius: 999px;
padding: 6px 10px;
border: 1px solid var(--border);
background: white;
font-size: 0.9rem;
cursor: pointer;
text-align: left;
transition: background 0.15s, border-color 0.15s, transform 0.05s;
}

.quiz-option:hover {
background: #eef2ff;
border-color: #c7d2fe;
transform: translateY(-1px);
}

.quiz-option.correct {
background: #dcfce7;
border-color: #22c55e;
}

.quiz-option.incorrect {
background: #fee2e2;
border-color: #ef4444;
}

.quiz-feedback {
margin-top: 6px;
font-size: 0.85rem;
}

.quiz-feedback.correct {
color: #15803d;
}

.quiz-feedback.incorrect {
color: #b91c1c;
}

footer {
text-align: center;
margin-top: 10px;
font-size: 0.75rem;
color: #64748b;
}
</style>
</head>
<body>
<div class="app-shell">
<header>
<div class="tagline">ğŸ§ è¦–è¦º + è½è¦º Â· åŠ ä¸Šæ”¶è—èˆ‡éŒ¯é¡Œæœ¬ï¼Œæ‰“é€ ä½ çš„æ—¥èªèµ·æ­¥èµ°</div>
<h1>æ—¥èªèµ·æ­¥èµ° <span>Jap Start 3.0</span></h1>
<p>é»ä¸€é»ã€è½ä¸€è½ã€æ¸¬ä¸€æ¸¬ï¼Œç”¨æœ€ç›´è¦ºçš„æ–¹å¼è¨˜ä½æ—¥æ–‡ç™¼éŸ³èˆ‡æ„æ€ã€‚</p>
<p>å»ºè­°ä½¿ç”¨æ”¯æ´ Web Speech API çš„æ‰‹æ©Ÿæˆ– Chrome ç€è¦½å™¨ã€‚</p>
</header>

<div class="layout">
<!-- å·¦å´ï¼šå–®å­—å­¸ç¿’ -->
<section class="panel panel-main">
<div class="list-header">
<h2>å­¸ç¿’å–®å…ƒ</h2>
<small>é»æ“Š ğŸ”Š æ”¶è½çœŸäººèªéŸ³åˆæˆï¼Œå¯åŠ åˆ°ã€Œæ”¶è—ã€èˆ‡ã€ŒéŒ¯é¡Œæœ¬ã€</small>
</div>

<div class="tabs" id="unit-tabs">
<button class="tab-btn active" data-unit="Hirakana">
å¹³å‡å <span class="en">Hiragana</span>
</button>
<button class="tab-btn" data-unit="Katakana">
ç‰‡å‡å <span class="en">Katakana</span>
</button>
<button class="tab-btn" data-unit="numbers">
æ•¸å­— 1â€“10 <span class="en">Numbers</span>
</button>
<button class="tab-btn" data-unit="phrases">
ç”Ÿæ´»æœƒè©± <span class="en">Phrases</span>
</button>
<button class="tab-btn" data-unit="time">
æ™‚é–“ <span class="en">Time</span>
</button>
<button class="tab-btn" data-unit="weekdays">
æ˜ŸæœŸ <span class="en">Weekdays</span>
</button>
<button class="tab-btn" data-unit="dates">
æ—¥æœŸ <span class="en">Dates</span>
</button>
<button class="tab-btn" data-unit="colors">
é¡è‰² <span class="en">Colors</span>
</button>
<button class="tab-btn" data-unit="favorites">
â­ æ”¶è—å–®å­—
</button>
<button class="tab-btn" data-unit="wrongbook">
âŒ éŒ¯é¡Œæœ¬
</button>
</div>

<div class="badge">
ğŸ’¡ æç¤ºï¼šæ—¥æ–‡ï¼ˆæ¼¢å­—ï¼‹å¹³å‡åï¼ç‰‡å‡åï¼‰ï¼‹ ç¾…é¦¬éŸ³ ï¼‹ ä¸­æ–‡ï¼Œä¸€æ¬¡è¨˜ä¸‰ç¨®è³‡è¨Š
</div>

<div class="entry-list" id="entry-list"></div>

<div id="unit-actions" style="margin-top:10px; display:none;">
<button id="clear-fav" class="fav-btn">ğŸ—‘ æ¸…ç©ºæ”¶è—</button>
<button id="clear-wrongbook" class="fav-btn" style="margin-left:6px;">ğŸ—‘ æ¸…ç©ºéŒ¯é¡Œæœ¬</button>
</div>

<div id="speech-warning" class="support-warning" style="display:none;">
âš ï¸ ä½ çš„ç€è¦½å™¨ä¼¼ä¹ä¸æ”¯æ´ Web Speech APIã€‚è«‹æ”¹ç”¨æœ€æ–°ç‰ˆ Chrome æˆ–æ”¯æ´èªéŸ³åˆæˆçš„è£ç½®ã€‚
</div>
</section>

<!-- å³å´ï¼šæ¸¬é©—æ¨¡å¼ -->
<section class="panel panel-quiz">
<h2>æ¸¬é©—æ¨¡å¼ Â· å³æ™‚è¨ˆåˆ†</h2>
<div class="quiz-controls">
<select id="quiz-unit" class="quiz-select">
<option value="Hirakana">å¹³å‡å</option>
<option value="Katakana">ç‰‡å‡å</option>
<option value="numbers">æ•¸å­— 1â€“10</option>
<option value="phrases">ç”Ÿæ´»æœƒè©±</option>
<option value="time">æ™‚é–“</option>
<option value="weekdays">æ˜ŸæœŸ</option>
<option value="dates">æ—¥æœŸ</option>
<option value="colors">é¡è‰²</option>
<option value="favorites">â­ æ”¶è—å–®å­—</option>
<option value="wrongbook">âŒ éŒ¯é¡Œæœ¬</option>
<option value="all">å…¨éƒ¨å–®å…ƒ</option>
</select>

<div class="quiz-mode-toggle">
<button class="pill-btn active" data-mode="listening">
ğŸ§ è½åŠ›æ¸¬é©—
</button>
<button class="pill-btn" data-mode="meaning">
ğŸ“ å–®å­—æ¸¬é©—
</button>
<button class="pill-btn" data-mode="kana">
ã‚â†”ã‚¢ äº’è½‰
</button>
</div>

<label style="font-size:0.8rem; display:flex; align-items:center; gap:4px; margin-top:4px;">
<input type="checkbox" id="auto-next" />
é€£çºŒç·´ç¿’æ¨¡å¼ï¼ˆè‡ªå‹•ä¸‹ä¸€é¡Œï¼‰
</label>

<button id="start-quiz" class="btn-primary">
â–¶ï¸ é–‹å§‹ / ä¸‹ä¸€é¡Œ
</button>
</div>

<div class="quiz-card" id="quiz-card" style="display:none;">
<div class="quiz-meta">
<span>é¡Œæ•¸ï¼š<span id="quiz-count">0</span></span>
<span>åˆ†æ•¸ï¼š<span id="quiz-score">0</span></span>
</div>

<div class="progress-wrap">
<div class="progress-text">
<span>ä»Šæ—¥ç›®æ¨™ï¼š10 é¡Œ</span>
<span><span id="progress-current">0</span> / 10</span>
</div>
<div class="progress-bar">
<div class="progress-inner" id="progress-inner"></div>
</div>
</div>

<div class="quiz-question-label" id="quiz-label"></div>
<div class="quiz-question-main" id="quiz-question"></div>

<div id="quiz-play-audio" style="margin-top:4px; display:none;">
<button class="speak-btn" id="quiz-speak-btn">
ğŸ”Š æ’­æ”¾é¡Œç›®
</button>
</div>

<div class="quiz-options" id="quiz-options"></div>

<div id="quiz-feedback" class="quiz-feedback"></div>
</div>
</section>
</div>

<footer>
Jap Start 3.0 Â· æ—¥èªèµ·æ­¥èµ° Â· å¯ä¾éœ€è¦æ“´å……æ›´å¤šå–®å…ƒã€é€²åº¦ç´€éŒ„èˆ‡å¸³è™Ÿç³»çµ±ã€‚
</footer>
</div>

<script>
console.log('Jap Start JS loaded');
window.addEventListener('DOMContentLoaded', function () {
// ====== è³‡æ–™å®šç¾©ï¼ˆåŠ å…¥ jp_kanjiï¼šæ¼¢å­—ï¼ˆã‹ãªï¼‰é¡¯ç¤ºç”¨ï¼‰ ======
const DATA = {
Hirakana: [
{ jp: "ã‚", romaji: "a", zh: "å¹³å‡å a", row: "ã‚è¡Œ" },
{ jp: "ã„", romaji: "i", zh: "å¹³å‡å i", row: "ã‚è¡Œ" },
{ jp: "ã†", romaji: "u", zh: "å¹³å‡å u", row: "ã‚è¡Œ" },
{ jp: "ãˆ", romaji: "e", zh: "å¹³å‡å e", row: "ã‚è¡Œ" },
{ jp: "ãŠ", romaji: "o", zh: "å¹³å‡å o", row: "ã‚è¡Œ" },

{ jp: "ã‹", romaji: "ka", zh: "å¹³å‡å ka", row: "ã‹è¡Œ" },
{ jp: "ã", romaji: "ki", zh: "å¹³å‡å ki", row: "ã‹è¡Œ" },
{ jp: "ã", romaji: "ku", zh: "å¹³å‡å ku", row: "ã‹è¡Œ" },
{ jp: "ã‘", romaji: "ke", zh: "å¹³å‡å ke", row: "ã‹è¡Œ" },
{ jp: "ã“", romaji: "ko", zh: "å¹³å‡å ko", row: "ã‹è¡Œ" },

{ jp: "ã•", romaji: "sa", zh: "å¹³å‡å sa", row: "ã•è¡Œ" },
{ jp: "ã—", romaji: "shi", zh: "å¹³å‡å shi", row: "ã•è¡Œ" },
{ jp: "ã™", romaji: "su", zh: "å¹³å‡å su", row: "ã•è¡Œ" },
{ jp: "ã›", romaji: "se", zh: "å¹³å‡å se", row: "ã•è¡Œ" },
{ jp: "ã", romaji: "so", zh: "å¹³å‡å so", row: "ã•è¡Œ" },

{ jp: "ãŸ", romaji: "ta", zh: "å¹³å‡å ta", row: "ãŸè¡Œ" },
{ jp: "ã¡", romaji: "chi", zh: "å¹³å‡å chi", row: "ãŸè¡Œ" },
{ jp: "ã¤", romaji: "tsu", zh: "å¹³å‡å tsu", row: "ãŸè¡Œ" },
{ jp: "ã¦", romaji: "te", zh: "å¹³å‡å te", row: "ãŸè¡Œ" },
{ jp: "ã¨", romaji: "to", zh: "å¹³å‡å to", row: "ãŸè¡Œ" },

{ jp: "ãª", romaji: "na", zh: "å¹³å‡å na", row: "ãªè¡Œ" },
{ jp: "ã«", romaji: "ni", zh: "å¹³å‡å ni", row: "ãªè¡Œ" },
{ jp: "ã¬", romaji: "nu", zh: "å¹³å‡å nu", row: "ãªè¡Œ" },
{ jp: "ã­", romaji: "ne", zh: "å¹³å‡å ne", row: "ãªè¡Œ" },
{ jp: "ã®", romaji: "no", zh: "å¹³å‡å no", row: "ãªè¡Œ" },

{ jp: "ã¯", romaji: "ha", zh: "å¹³å‡å ha", row: "ã¯è¡Œ" },
{ jp: "ã²", romaji: "hi", zh: "å¹³å‡å hi", row: "ã¯è¡Œ" },
{ jp: "ãµ", romaji: "fu", zh: "å¹³å‡å fu", row: "ã¯è¡Œ" },
{ jp: "ã¸", romaji: "he", zh: "å¹³å‡å he", row: "ã¯è¡Œ" },
{ jp: "ã»", romaji: "ho", zh: "å¹³å‡å ho", row: "ã¯è¡Œ" },

{ jp: "ã¾", romaji: "ma", zh: "å¹³å‡å ma", row: "ã¾è¡Œ" },
{ jp: "ã¿", romaji: "mi", zh: "å¹³å‡å mi", row: "ã¾è¡Œ" },
{ jp: "ã‚€", romaji: "mu", zh: "å¹³å‡å mu", row: "ã¾è¡Œ" },
{ jp: "ã‚", romaji: "me", zh: "å¹³å‡å me", row: "ã¾è¡Œ" },
{ jp: "ã‚‚", romaji: "mo", zh: "å¹³å‡å mo", row: "ã¾è¡Œ" },

{ jp: "ã‚„", romaji: "ya", zh: "å¹³å‡å ya", row: "ã‚„è¡Œ" },
{ jp: "ã‚†", romaji: "yu", zh: "å¹³å‡å yu", row: "ã‚„è¡Œ" },
{ jp: "ã‚ˆ", romaji: "yo", zh: "å¹³å‡å yo", row: "ã‚„è¡Œ" },

{ jp: "ã‚‰", romaji: "ra", zh: "å¹³å‡å ra", row: "ã‚‰è¡Œ" },
{ jp: "ã‚Š", romaji: "ri", zh: "å¹³å‡å ri", row: "ã‚‰è¡Œ" },
{ jp: "ã‚‹", romaji: "ru", zh: "å¹³å‡å ru", row: "ã‚‰è¡Œ" },
{ jp: "ã‚Œ", romaji: "re", zh: "å¹³å‡å re", row: "ã‚‰è¡Œ" },
{ jp: "ã‚", romaji: "ro", zh: "å¹³å‡å ro", row: "ã‚‰è¡Œ" },

{ jp: "ã‚", romaji: "wa", zh: "å¹³å‡å wa", row: "ã‚è¡Œ" },
{ jp: "ã‚’", romaji: "o / wo", zh: "å¹³å‡å o / wo", row: "ã‚è¡Œ" },
{ jp: "ã‚“", romaji: "n", zh: "å¹³å‡å n", row: "ã‚“" }
],

Katakana: [
{ jp: "ã‚¢", romaji: "a", zh: "ç‰‡å‡å a", row: "ã‚¢è¡Œ" },
{ jp: "ã‚¤", romaji: "i", zh: "ç‰‡å‡å i", row: "ã‚¢è¡Œ" },
{ jp: "ã‚¦", romaji: "u", zh: "ç‰‡å‡å u", row: "ã‚¢è¡Œ" },
{ jp: "ã‚¨", romaji: "e", zh: "ç‰‡å‡å e", row: "ã‚¢è¡Œ" },
{ jp: "ã‚ª", romaji: "o", zh: "ç‰‡å‡å o", row: "ã‚¢è¡Œ" },

{ jp: "ã‚«", romaji: "ka", zh: "ç‰‡å‡å ka", row: "ã‚«è¡Œ" },
{ jp: "ã‚­", romaji: "ki", zh: "ç‰‡å‡å ki", row: "ã‚«è¡Œ" },
{ jp: "ã‚¯", romaji: "ku", zh: "ç‰‡å‡å ku", row: "ã‚«è¡Œ" },
{ jp: "ã‚±", romaji: "ke", zh: "ç‰‡å‡å ke", row: "ã‚«è¡Œ" },
{ jp: "ã‚³", romaji: "ko", zh: "ç‰‡å‡å ko", row: "ã‚«è¡Œ" },

{ jp: "ã‚µ", romaji: "sa", zh: "ç‰‡å‡å sa", row: "ã‚µè¡Œ" },
{ jp: "ã‚·", romaji: "shi", zh: "ç‰‡å‡å shi", row: "ã‚µè¡Œ" },
{ jp: "ã‚¹", romaji: "su", zh: "ç‰‡å‡å su", row: "ã‚µè¡Œ" },
{ jp: "ã‚»", romaji: "se", zh: "ç‰‡å‡å se", row: "ã‚µè¡Œ" },
{ jp: "ã‚½", romaji: "so", zh: "ç‰‡å‡å so", row: "ã‚µè¡Œ" },

{ jp: "ã‚¿", romaji: "ta", zh: "ç‰‡å‡å ta", row: "ã‚¿è¡Œ" },
{ jp: "ãƒ", romaji: "chi", zh: "ç‰‡å‡å chi", row: "ã‚¿è¡Œ" },
{ jp: "ãƒ„", romaji: "tsu", zh: "ç‰‡å‡å tsu", row: "ã‚¿è¡Œ" },
{ jp: "ãƒ†", romaji: "te", zh: "ç‰‡å‡å te", row: "ã‚¿è¡Œ" },
{ jp: "ãƒˆ", romaji: "to", zh: "ç‰‡å‡å to", row: "ã‚¿è¡Œ" },

{ jp: "ãƒŠ", romaji: "na", zh: "ç‰‡å‡å na", row: "ãƒŠè¡Œ" },
{ jp: "ãƒ‹", romaji: "ni", zh: "ç‰‡å‡å ni", row: "ãƒŠè¡Œ" },
{ jp: "ãƒŒ", romaji: "nu", zh: "ç‰‡å‡å nu", row: "ãƒŠè¡Œ" },
{ jp: "ãƒ", romaji: "ne", zh: "ç‰‡å‡å ne", row: "ãƒŠè¡Œ" },
{ jp: "ãƒ", romaji: "no", zh: "ç‰‡å‡å no", row: "ãƒŠè¡Œ" },

{ jp: "ãƒ", romaji: "ha", zh: "ç‰‡å‡å ha", row: "ãƒè¡Œ" },
{ jp: "ãƒ’", romaji: "hi", zh: "ç‰‡å‡å hi", row: "ãƒè¡Œ" },
{ jp: "ãƒ•", romaji: "fu", zh: "ç‰‡å‡å fu", row: "ãƒè¡Œ" },
{ jp: "ãƒ˜", romaji: "he", zh: "ç‰‡å‡å he", row: "ãƒè¡Œ" },
{ jp: "ãƒ›", romaji: "ho", zh: "ç‰‡å‡å ho", row: "ãƒè¡Œ" },

{ jp: "ãƒ", romaji: "ma", zh: "ç‰‡å‡å ma", row: "ãƒè¡Œ" },
{ jp: "ãƒŸ", romaji: "mi", zh: "ç‰‡å‡å mi", row: "ãƒè¡Œ" },
{ jp: "ãƒ ", romaji: "mu", zh: "ç‰‡å‡å mu", row: "ãƒè¡Œ" },
{ jp: "ãƒ¡", romaji: "me", zh: "ç‰‡å‡å me", row: "ãƒè¡Œ" },
{ jp: "ãƒ¢", romaji: "mo", zh: "ç‰‡å‡å mo", row: "ãƒè¡Œ" },

{ jp: "ãƒ¤", romaji: "ya", zh: "ç‰‡å‡å ya", row: "ãƒ¤è¡Œ" },
{ jp: "ãƒ¦", romaji: "yu", zh: "ç‰‡å‡å yu", row: "ãƒ¤è¡Œ" },
{ jp: "ãƒ¨", romaji: "yo", zh: "ç‰‡å‡å yo", row: "ãƒ¤è¡Œ" },

{ jp: "ãƒ©", romaji: "ra", zh: "ç‰‡å‡å ra", row: "ãƒ©è¡Œ" },
{ jp: "ãƒª", romaji: "ri", zh: "ç‰‡å‡å ri", row: "ãƒ©è¡Œ" },
{ jp: "ãƒ«", romaji: "ru", zh: "ç‰‡å‡å ru", row: "ãƒ©è¡Œ" },
{ jp: "ãƒ¬", romaji: "re", zh: "ç‰‡å‡å re", row: "ãƒ©è¡Œ" },
{ jp: "ãƒ­", romaji: "ro", zh: "ç‰‡å‡å ro", row: "ãƒ©è¡Œ" },

{ jp: "ãƒ¯", romaji: "wa", zh: "ç‰‡å‡å wa", row: "ãƒ¯è¡Œ" },
{ jp: "ãƒ²", romaji: "o / wo", zh: "ç‰‡å‡å o / wo", row: "ãƒ¯è¡Œ" },
{ jp: "ãƒ³", romaji: "n", zh: "ç‰‡å‡å n", row: "ãƒ³" }
],

numbers: [
{ jp: "ã„ã¡", romaji: "ichi", zh: "ä¸€ï¼ˆ1ï¼‰", jp_kanji: "ä¸€ï¼ˆã„ã¡ï¼‰" },
{ jp: "ã«", romaji: "ni", zh: "äºŒï¼ˆ2ï¼‰", jp_kanji: "äºŒï¼ˆã«ï¼‰" },
{ jp: "ã•ã‚“", romaji: "san", zh: "ä¸‰ï¼ˆ3ï¼‰", jp_kanji: "ä¸‰ï¼ˆã•ã‚“ï¼‰" },
{ jp: "ã‚ˆã‚“ / ã—", romaji: "yon / shi", zh: "å››ï¼ˆ4ï¼‰", jp_kanji: "å››ï¼ˆã‚ˆã‚“ï¼ã—ï¼‰" },
{ jp: "ã”", romaji: "go", zh: "äº”ï¼ˆ5ï¼‰", jp_kanji: "äº”ï¼ˆã”ï¼‰" },
{ jp: "ã‚ã", romaji: "roku", zh: "å…­ï¼ˆ6ï¼‰", jp_kanji: "å…­ï¼ˆã‚ãï¼‰" },
{ jp: "ãªãª / ã—ã¡", romaji: "nana / shichi", zh: "ä¸ƒï¼ˆ7ï¼‰", jp_kanji: "ä¸ƒï¼ˆãªãªï¼ã—ã¡ï¼‰" },
{ jp: "ã¯ã¡", romaji: "hachi", zh: "å…«ï¼ˆ8ï¼‰", jp_kanji: "å…«ï¼ˆã¯ã¡ï¼‰" },
{ jp: "ãã‚…ã† / ã", romaji: "kyuu / ku", zh: "ä¹ï¼ˆ9ï¼‰", jp_kanji: "ä¹ï¼ˆãã‚…ã†ï¼ãï¼‰" },
{ jp: "ã˜ã‚…ã†", romaji: "juu", zh: "åï¼ˆ10ï¼‰", jp_kanji: "åï¼ˆã˜ã‚…ã†ï¼‰" }
],

phrases: [
{ jp: "ã“ã‚“ã«ã¡ã¯", romaji: "konnichiwa", zh: "ä½ å¥½ï¼åˆå®‰", jp_kanji: "ä»Šæ—¥ã¯ï¼ˆã“ã‚“ã«ã¡ã¯ï¼‰" },
{ jp: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™", romaji: "ohayou gozaimasu", zh: "æ—©å®‰ï¼ˆæ•¬èªï¼‰", jp_kanji: "ãŠæ—©ã†ã”ã–ã„ã¾ã™ï¼ˆãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼‰" },
{ jp: "ã“ã‚“ã°ã‚“ã¯", romaji: "konbanwa", zh: "æ™šå®‰ï¼ˆæ‰“æ‹›å‘¼ï¼‰", jp_kanji: "ä»Šæ™©ã¯ï¼ˆã“ã‚“ã°ã‚“ã¯ï¼‰" },
{ jp: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", romaji: "arigatou gozaimasu", zh: "éå¸¸æ„Ÿè¬", jp_kanji: "æœ‰é›£ã†ã”ã–ã„ã¾ã™ï¼ˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼‰" },
{ jp: "ã™ã¿ã¾ã›ã‚“", romaji: "sumimasen", zh: "ä¸å¥½æ„æ€ï¼å°ä¸èµ·", jp_kanji: "æ¸ˆã¿ã¾ã›ã‚“ï¼ˆã™ã¿ã¾ã›ã‚“ï¼‰" },
{ jp: "ã¯ã„", romaji: "hai", zh: "æ˜¯ï¼å¥½" },
{ jp: "ã„ã„ãˆ", romaji: "iie", zh: "ä¸æ˜¯ï¼ä¸" },
{ jp: "ãŠé¡˜ã„ã—ã¾ã™", romaji: "onegaishimasu", zh: "æ‹œè¨—äº†ï¼éº»ç…©ä½ ", jp_kanji: "ãŠé¡˜ã„ã—ã¾ã™ï¼ˆãŠã­ãŒã„ã—ã¾ã™ï¼‰" },
{ jp: "å¤§ä¸ˆå¤«ã§ã™", romaji: "daijoubu desu", zh: "æ²’å•é¡Œï¼æˆ‘æ²’äº‹", jp_kanji: "å¤§ä¸ˆå¤«ã§ã™ï¼ˆã ã„ã˜ã‚‡ã†ã¶ã§ã™ï¼‰" },
{ jp: "ã©ã“ã§ã™ã‹ï¼Ÿ", romaji: "doko desu ka?", zh: "åœ¨å“ªè£¡ï¼Ÿ", jp_kanji: "ã©ã“ã§ã™ã‹ï¼Ÿ" }
],

time: [
{ jp: "ã„ã¾", romaji: "ima", zh: "ç¾åœ¨", jp_kanji: "ä»Šï¼ˆã„ã¾ï¼‰" },
{ jp: "â—‹ã˜", romaji: "â—‹ ji", zh: "ï½é»ï¼ˆæ•´é»ï¼‰", jp_kanji: "ï½æ™‚ï¼ˆï½ã˜ï¼‰" },
{ jp: "ã”ãœã‚“", romaji: "gozen", zh: "ä¸Šåˆ", jp_kanji: "åˆå‰ï¼ˆã”ãœã‚“ï¼‰" },
{ jp: "ã”ã”", romaji: "gogo", zh: "ä¸‹åˆ", jp_kanji: "åˆå¾Œï¼ˆã”ã”ï¼‰" },
{ jp: "ãªã‚“ã˜ã§ã™ã‹ï¼Ÿ", romaji: "nanji desu ka?", zh: "ç¾åœ¨å¹¾é»ï¼Ÿ", jp_kanji: "ä½•æ™‚ã§ã™ã‹ï¼Ÿï¼ˆãªã‚“ã˜ã§ã™ã‹ï¼Ÿï¼‰" },
{ jp: "â—‹ã˜ã¯ã‚“", romaji: "â—‹ ji han", zh: "ï½é»åŠ", jp_kanji: "ï½æ™‚åŠï¼ˆï½ã˜ã¯ã‚“ï¼‰" },
{ jp: "ã„ã¡ã˜", romaji: "ichiji", zh: "ä¸€é»", jp_kanji: "ä¸€æ™‚ï¼ˆã„ã¡ã˜ï¼‰" },
{ jp: "ã«ã˜", romaji: "niji", zh: "å…©é»", jp_kanji: "äºŒæ™‚ï¼ˆã«ã˜ï¼‰" },
{ jp: "ã•ã‚“ã˜", romaji: "sanji", zh: "ä¸‰é»", jp_kanji: "ä¸‰æ™‚ï¼ˆã•ã‚“ã˜ï¼‰" },
{ jp: "ã—ã¡ã˜", romaji: "shichiji", zh: "ä¸ƒé»", jp_kanji: "ä¸ƒæ™‚ï¼ˆã—ã¡ã˜ï¼‰" }
],

weekdays: [
{ jp: "ã’ã¤ã‚ˆã†ã³", romaji: "getsuyoubi", zh: "æ˜ŸæœŸä¸€", jp_kanji: "æœˆæ›œæ—¥ï¼ˆã’ã¤ã‚ˆã†ã³ï¼‰" },
{ jp: "ã‹ã‚ˆã†ã³", romaji: "kayoubi", zh: "æ˜ŸæœŸäºŒ", jp_kanji: "ç«æ›œæ—¥ï¼ˆã‹ã‚ˆã†ã³ï¼‰" },
{ jp: "ã™ã„ã‚ˆã†ã³", romaji: "suiyoubi", zh: "æ˜ŸæœŸä¸‰", jp_kanji: "æ°´æ›œæ—¥ï¼ˆã™ã„ã‚ˆã†ã³ï¼‰" },
{ jp: "ã‚‚ãã‚ˆã†ã³", romaji: "mokuyoubi", zh: "æ˜ŸæœŸå››", jp_kanji: "æœ¨æ›œæ—¥ï¼ˆã‚‚ãã‚ˆã†ã³ï¼‰" },
{ jp: "ãã‚“ã‚ˆã†ã³", romaji: "kinyoubi", zh: "æ˜ŸæœŸäº”", jp_kanji: "é‡‘æ›œæ—¥ï¼ˆãã‚“ã‚ˆã†ã³ï¼‰" },
{ jp: "ã©ã‚ˆã†ã³", romaji: "doyoubi", zh: "æ˜ŸæœŸå…­", jp_kanji: "åœŸæ›œæ—¥ï¼ˆã©ã‚ˆã†ã³ï¼‰" },
{ jp: "ã«ã¡ã‚ˆã†ã³", romaji: "nichiyoubi", zh: "æ˜ŸæœŸæ—¥", jp_kanji: "æ—¥æ›œæ—¥ï¼ˆã«ã¡ã‚ˆã†ã³ï¼‰" },
{ jp: "ãã‚‡ã†", romaji: "kyou", zh: "ä»Šå¤©", jp_kanji: "ä»Šæ—¥ï¼ˆãã‚‡ã†ï¼‰" },
{ jp: "ã‚ã—ãŸ", romaji: "ashita", zh: "æ˜å¤©", jp_kanji: "æ˜æ—¥ï¼ˆã‚ã—ãŸï¼‰" },
{ jp: "ãã®ã†", romaji: "kinou", zh: "æ˜¨å¤©", jp_kanji: "æ˜¨æ—¥ï¼ˆãã®ã†ï¼‰" }
],

dates: [
{ jp: "ãã‚‡ã†", romaji: "kyou", zh: "ä»Šå¤©", jp_kanji: "ä»Šæ—¥ï¼ˆãã‚‡ã†ï¼‰" },
{ jp: "ã‚ã—ãŸ", romaji: "ashita", zh: "æ˜å¤©", jp_kanji: "æ˜æ—¥ï¼ˆã‚ã—ãŸï¼‰" },
{ jp: "ãã®ã†", romaji: "kinou", zh: "æ˜¨å¤©", jp_kanji: "æ˜¨æ—¥ï¼ˆãã®ã†ï¼‰" },
{ jp: "ã‚ã•ã£ã¦", romaji: "asatte", zh: "å¾Œå¤©", jp_kanji: "æ˜å¾Œæ—¥ï¼ˆã‚ã•ã£ã¦ï¼‰" },
{ jp: "ãŠã¨ã¨ã„", romaji: "ototoi", zh: "å‰å¤©", jp_kanji: "ä¸€æ˜¨æ—¥ï¼ˆãŠã¨ã¨ã„ï¼‰" },
{ jp: "ã‚‰ã„ã—ã‚…ã†", romaji: "raishuu", zh: "ä¸‹é€±", jp_kanji: "æ¥é€±ï¼ˆã‚‰ã„ã—ã‚…ã†ï¼‰" },
{ jp: "ã›ã‚“ã—ã‚…ã†", romaji: "senshuu", zh: "ä¸Šé€±", jp_kanji: "å…ˆé€±ï¼ˆã›ã‚“ã—ã‚…ã†ï¼‰" },
{ jp: "ã“ã‚“ã—ã‚…ã†", romaji: "konshuu", zh: "æœ¬é€±", jp_kanji: "ä»Šé€±ï¼ˆã“ã‚“ã—ã‚…ã†ï¼‰" },
{ jp: "ã‚‰ã„ã’ã¤", romaji: "raigetsu", zh: "ä¸‹å€‹æœˆ", jp_kanji: "æ¥æœˆï¼ˆã‚‰ã„ã’ã¤ï¼‰" },
{ jp: "ã›ã‚“ã’ã¤", romaji: "sengetsu", zh: "ä¸Šå€‹æœˆ", jp_kanji: "å…ˆæœˆï¼ˆã›ã‚“ã’ã¤ï¼‰" }
],

colors: [
{ jp: "ã‚ã‹", romaji: "aka", zh: "ç´…è‰²", jp_kanji: "èµ¤ï¼ˆã‚ã‹ï¼‰" },
{ jp: "ã‚ãŠ", romaji: "ao", zh: "è—è‰²ï¼é’è‰²", jp_kanji: "é’ï¼ˆã‚ãŠï¼‰" },
{ jp: "ãã„ã‚", romaji: "kiiro", zh: "é»ƒè‰²", jp_kanji: "é»„è‰²ï¼ˆãã„ã‚ï¼‰" },
{ jp: "ã—ã‚", romaji: "shiro", zh: "ç™½è‰²", jp_kanji: "ç™½ï¼ˆã—ã‚ï¼‰" },
{ jp: "ãã‚", romaji: "kuro", zh: "é»‘è‰²", jp_kanji: "é»’ï¼ˆãã‚ï¼‰" },
{ jp: "ã¿ã©ã‚Š", romaji: "midori", zh: "ç¶ è‰²", jp_kanji: "ç·‘ï¼ˆã¿ã©ã‚Šï¼‰" },
{ jp: "ãƒ”ãƒ³ã‚¯", romaji: "pinku", zh: "ç²‰ç´…è‰²", jp_kanji: "ãƒ”ãƒ³ã‚¯" },
{ jp: "ã‚€ã‚‰ã•ã", romaji: "murasaki", zh: "ç´«è‰²", jp_kanji: "ç´«ï¼ˆã‚€ã‚‰ã•ãï¼‰" },
{ jp: "ã¡ã‚ƒã„ã‚", romaji: "chairo", zh: "å’–å•¡è‰²ï¼èŒ¶è‰²", jp_kanji: "èŒ¶è‰²ï¼ˆã¡ã‚ƒã„ã‚ï¼‰" },
{ jp: "ã‚ªãƒ¬ãƒ³ã‚¸", romaji: "orenji", zh: "æ©™è‰²", jp_kanji: "ã‚ªãƒ¬ãƒ³ã‚¸" }
]
};

// ====== æ”¶è— / éŒ¯é¡Œæœ¬ ======
let favorites = [];
let wrongBook = [];
const FAVORITES_KEY = "japStartFavorites";
const WRONGBOOK_KEY = "japStartWrongBook";

function loadFromStorage() {
try {
const favRaw = localStorage.getItem(FAVORITES_KEY);
const wrongRaw = localStorage.getItem(WRONGBOOK_KEY);
favorites = favRaw ? JSON.parse(favRaw) : [];
wrongBook = wrongRaw ? JSON.parse(wrongRaw) : [];
} catch (e) {
favorites = [];
wrongBook = [];
}
}
function saveFavorites() {
try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites)); } catch (e) {}
}
function saveWrongBook() {
try { localStorage.setItem(WRONGBOOK_KEY, JSON.stringify(wrongBook)); } catch (e) {}
}
function sameItem(a, b) {
return a.jp === b.jp && a.romaji === b.romaji && a.zh === b.zh;
}
function isFavorited(item) {
return favorites.some((f) => sameItem(f, item));
}
function addToFavorites(item) {
if (!isFavorited(item)) {
favorites.push(item);
saveFavorites();
}
}
function removeFromFavorites(item) {
favorites = favorites.filter((f) => !sameItem(f, item));
saveFavorites();
}
function toggleFavorite(item) {
if (isFavorited(item)) {
removeFromFavorites(item);
} else {
addToFavorites(item);
}
}
function addToWrongBook(item) {
if (!wrongBook.some((f) => sameItem(f, item))) {
wrongBook.push(item);
saveWrongBook();
}
}
function removeFromWrongBook(item) {
wrongBook = wrongBook.filter((f) => !sameItem(f, item));
saveWrongBook();
}

loadFromStorage();

// ====== èªéŸ³åˆæˆ ======
const speechSupported = "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
const speechWarningEl = document.getElementById("speech-warning");
if (!speechSupported) {
speechWarningEl.style.display = "block";
}
function speakJapanese(text) {
if (!speechSupported) return;
window.speechSynthesis.cancel();
const utter = new SpeechSynthesisUtterance(text);
utter.lang = "ja-JP";
utter.rate = 1.0;
utter.pitch = 1.0;
window.speechSynthesis.speak(utter);
}

// ====== å·¦å´æ¸²æŸ“ ======
const entryListEl = document.getElementById("entry-list");
const tabButtons = document.querySelectorAll(".tab-btn");
const unitActions = document.getElementById("unit-actions");
const clearFavBtn = document.getElementById("clear-fav");
const clearWrongBtn = document.getElementById("clear-wrongbook");
let currentUnit = "Hirakana";

function getItemsForUnit(unitKey) {
if (unitKey === "favorites") return favorites;
if (unitKey === "wrongbook") return wrongBook;
return DATA[unitKey] || [];
}

function updateActionButtons() {
if (currentUnit === "favorites" || currentUnit === "wrongbook") {
unitActions.style.display = "block";
} else {
unitActions.style.display = "none";
}
}

function renderUnit(unitKey) {
entryListEl.innerHTML = "";
const items = getItemsForUnit(unitKey);

if (!items.length) {
const hint = document.createElement("div");
hint.className = "empty-hint";
if (unitKey === "favorites") {
hint.textContent = "â­ ç›®å‰é‚„æ²’æœ‰æ”¶è—å–®å­—ï¼Œè«‹åœ¨å·¦å´å–®å…ƒä¸­æŒ‰ã€Œæ”¶è—ã€åŠ å…¥ã€‚";
} else if (unitKey === "wrongbook") {
hint.textContent = "âŒ é‚„æ²’æœ‰éŒ¯é¡Œç´€éŒ„ï¼Œæ¸¬é©—ç­”éŒ¯çš„é¡Œç›®æœƒè‡ªå‹•åŠ å…¥é€™è£¡ã€‚";
} else {
hint.textContent = "æ­¤å–®å…ƒå°šç„¡è³‡æ–™ã€‚";
}
entryListEl.appendChild(hint);
updateActionButtons();
return;
}

items.forEach((item) => {
const row = document.createElement("div");
row.className = "entry";

const colJP = document.createElement("div");
colJP.className = "entry-main";
const jpDisplay = item.jp_kanji || item.jp;
colJP.textContent = jpDisplay;

const colRomaji = document.createElement("div");
colRomaji.innerHTML = `<span class="sub">${item.romaji}</span>`;

const colZH = document.createElement("div");
colZH.innerHTML = `<span class="sub">${item.zh}</span>`;

const colBtnSpeak = document.createElement("div");
const speakBtn = document.createElement("button");
speakBtn.className = "speak-btn";
speakBtn.textContent = "ğŸ”Š æœ—è®€";
speakBtn.addEventListener("click", () => speakJapanese(item.jp));
colBtnSpeak.appendChild(speakBtn);

const colBtnFav = document.createElement("div");
const favBtn = document.createElement("button");
favBtn.className = "fav-btn";
if (isFavorited(item)) {
favBtn.classList.add("favorited");
favBtn.textContent = "â˜… å·²æ”¶è—";
} else {
favBtn.textContent = "â˜† æ”¶è—";
}
favBtn.addEventListener("click", () => {
toggleFavorite(item);
renderUnit(currentUnit);
});
colBtnFav.appendChild(favBtn);

row.appendChild(colJP);
row.appendChild(colRomaji);
row.appendChild(colZH);
row.appendChild(colBtnSpeak);
row.appendChild(colBtnFav);

entryListEl.appendChild(row);
});

updateActionButtons();
}

tabButtons.forEach((btn) => {
btn.addEventListener("click", () => {
tabButtons.forEach((b) => b.classList.remove("active"));
btn.classList.add("active");
currentUnit = btn.dataset.unit;
renderUnit(currentUnit);
});
});

// æ¸…ç©ºæ”¶è—
clearFavBtn.addEventListener("click", () => {
if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—å–®å­—å—ï¼Ÿ")) {
favorites = [];
saveFavorites();
if (currentUnit === "favorites") renderUnit("favorites");
alert("æ”¶è—å·²æ¸…ç©ºï¼");
}
});

// æ¸…ç©ºéŒ¯é¡Œæœ¬
clearWrongBtn.addEventListener("click", () => {
if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰éŒ¯é¡Œç´€éŒ„å—ï¼Ÿ")) {
wrongBook = [];
saveWrongBook();
if (currentUnit === "wrongbook") renderUnit("wrongbook");
alert("éŒ¯é¡Œæœ¬å·²æ¸…ç©ºï¼");
}
});

renderUnit(currentUnit);

// ====== æ¸¬é©—æ¨¡å¼ ======
const quizUnitSelect = document.getElementById("quiz-unit");
const quizModeButtons = document.querySelectorAll(".pill-btn");
const startQuizBtn = document.getElementById("start-quiz");
const autoNextCheckbox = document.getElementById("auto-next");

const quizCard = document.getElementById("quiz-card");
const quizLabel = document.getElementById("quiz-label");
const quizQuestion = document.getElementById("quiz-question");
const quizOptionsEl = document.getElementById("quiz-options");
const quizCountEl = document.getElementById("quiz-count");
const quizScoreEl = document.getElementById("quiz-score");
const quizFeedbackEl = document.getElementById("quiz-feedback");
const quizPlayAudioWrap = document.getElementById("quiz-play-audio");
const quizSpeakBtn = document.getElementById("quiz-speak-btn");
const progressInner = document.getElementById("progress-inner");
const progressCurrentEl = document.getElementById("progress-current");

const QUIZ_GOAL = 10;
let quizMode = "listening";
let quizCount = 0;
let quizScore = 0;
let currentAnswerIndex = -1;
let currentQuestionItem = null;

quizModeButtons.forEach((btn) => {
btn.addEventListener("click", () => {
quizModeButtons.forEach((b) => b.classList.remove("active"));
btn.classList.add("active");
quizMode = btn.dataset.mode;
});
});

function getPool(unitKey) {
if (unitKey === "all") {
return [
...DATA.Hirakana,
...DATA.Katakana,
...DATA.numbers,
...DATA.phrases,
...DATA.time,
...DATA.weekdays,
...DATA.dates,
...DATA.colors
];
}
if (unitKey === "favorites") return favorites;
if (unitKey === "wrongbook") return wrongBook;
return DATA[unitKey] || [];
}

function shuffle(array) {
const arr = array.slice();
for (let i = arr.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[arr[i], arr[j]] = [arr[j], arr[i]];
}
return arr;
}

function updateProgress() {
const current = Math.min(quizCount, QUIZ_GOAL);
const percent = (current / QUIZ_GOAL) * 100;
progressCurrentEl.textContent = current;
progressInner.style.width = percent + "%";
}

// å¹³å‡åï¼ç‰‡å‡åäº’è½‰é¡Œ
function generateKanaQuestion() {
const unit = quizUnitSelect.value;
const hiraList = DATA.Hirakana;
const kataList = DATA.Katakana;

let direction = "hira-to-kata";
if (unit === "Katakana") {
direction = "kata-to-hira";
} else if (unit === "all") {
direction = Math.random() < 0.5 ? "hira-to-kata" : "kata-to-hira";
} else if (unit !== "Hirakana") {
alert("ã‚â†”ã‚¢ äº’è½‰æ¸¬é©—åªé©ç”¨æ–¼ï¼šå¹³å‡åã€ç‰‡å‡åæˆ–å…¨éƒ¨å–®å…ƒã€‚");
return;
}

const questionList = direction === "hira-to-kata" ? hiraList : kataList;
const answerList = direction === "hira-to-kata" ? kataList : hiraList;
if (!questionList.length || !answerList.length) {
alert("è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œäº’è½‰æ¸¬é©—ã€‚");
return;
}

quizCard.style.display = "block";
quizFeedbackEl.textContent = "";
quizFeedbackEl.className = "quiz-feedback";
quizOptionsEl.innerHTML = "";

const qItem = questionList[Math.floor(Math.random() * questionList.length)];
const correctAnswer = answerList.find((x) => x.romaji === qItem.romaji);
if (!correctAnswer) {
console.warn("æ‰¾ä¸åˆ°å°æ‡‰çš„äº’è½‰ç­”æ¡ˆï¼š", qItem);
return;
}

const distractorCandidates = answerList.filter((x) => x.jp !== correctAnswer.jp);
const distractors = shuffle(distractorCandidates).slice(0, 3);
const options = shuffle([correctAnswer, ...distractors]);

currentQuestionItem = correctAnswer;
currentAnswerIndex = options.findIndex((o) => o.jp === correctAnswer.jp);

quizCount++;
quizCountEl.textContent = quizCount;
updateProgress();

quizLabel.textContent =
direction === "hira-to-kata"
? "ã‹ãªäº’è½‰ï¼šè«‹é¸å‡ºå°æ‡‰çš„ç‰‡å‡å"
: "ã‹ãªäº’è½‰ï¼šè«‹é¸å‡ºå°æ‡‰çš„å¹³å‡å";

const rowHint = qItem.row ? `ï¼ˆ${qItem.row}ï¼‰` : "";
quizQuestion.textContent = `é¡Œç›®ï¼š${qItem.jp} ${rowHint}`;
quizPlayAudioWrap.style.display = "block";
quizSpeakBtn.onclick = () => speakJapanese(qItem.jp);

options.forEach((item, idx) => {
const btn = document.createElement("button");
btn.className = "quiz-option";
btn.textContent = item.jp;
btn.addEventListener("click", () => handleAnswer(idx));
quizOptionsEl.appendChild(btn);
});

speakJapanese(qItem.jp);
}

function generateQuestion() {
if (quizMode === "kana") {
generateKanaQuestion();
return;
}

const unitKey = quizUnitSelect.value;
const pool = getPool(unitKey);
if (unitKey === "wrongbook" && pool.length === 0) {
alert("éŒ¯é¡Œæœ¬ç›®å‰æ˜¯ç©ºçš„ï¼Œå…ˆåšå…¶ä»–å–®å…ƒç´¯ç©éŒ¯é¡Œå§ï¼");
return;
}
if (pool.length < 2) {
alert("æ­¤å–®å…ƒè³‡æ–™ä¸è¶³ä»¥å‡ºé¡Œï¼ˆè‡³å°‘éœ€è¦ 2 å€‹å–®å­—ï¼‰ã€‚");
return;
}

quizCard.style.display = "block";
quizFeedbackEl.textContent = "";
quizFeedbackEl.className = "quiz-feedback";
quizOptionsEl.innerHTML = "";

const shuffled = shuffle(pool);
const correctItem = shuffled[0];
const distractors = shuffled.slice(1, 4);
const options = shuffle([correctItem, ...distractors]);

currentQuestionItem = correctItem;
currentAnswerIndex = options.indexOf(correctItem);

quizCount++;
quizCountEl.textContent = quizCount;
updateProgress();

const isKanaUnit = (unitKey === "Hirakana" || unitKey === "Katakana");
const rowHint = isKanaUnit && correctItem.row ? ` Â· æç¤ºï¼š${correctItem.row}` : "";
const jpDisplay = correctItem.jp_kanji || correctItem.jp;

// ===== è½åŠ›æ¸¬é©—ï¼šæ°¸é æ˜¯ã€Œè½å‡åã€ï¼Œé¸å°æ‡‰çš„æ±è¥¿ï¼ˆå¹³å‡åï¼ç‰‡å‡åå–®å…ƒ â†’ é¸å‡åï¼›å…¶ä»–å–®å…ƒ â†’ é¸ä¸­æ–‡ï¼‰ =====
if (quizMode === "listening") {
quizPlayAudioWrap.style.display = "block";
quizSpeakBtn.onclick = () => speakJapanese(correctItem.jp);
speakJapanese(correctItem.jp);

if (isKanaUnit) {
// å¹³å‡åï¼ç‰‡å‡åï¼šè½å‡å â†’ é¸å‡å
quizLabel.textContent = "è½åŠ›æ¸¬é©—ï¼šè«‹é¸å‡ºæ­£ç¢ºçš„å‡å" + rowHint;
quizQuestion.textContent = "è«‹å…ˆè½è®€éŸ³ï¼Œå†é¸å‡ºæ­£ç¢ºçš„å‡åã€‚";

options.forEach((item, idx) => {
const btn = document.createElement("button");
btn.className = "quiz-option";
btn.textContent = item.jp;
btn.addEventListener("click", () => handleAnswer(idx));
quizOptionsEl.appendChild(btn);
});
} else {
// å…¶ä»–å–®å…ƒï¼šè½æ—¥æ–‡ â†’ é¸ä¸­æ–‡
quizLabel.textContent = "è½åŠ›æ¸¬é©—ï¼šè«‹é¸å‡ºæ­£ç¢ºçš„ä¸­æ–‡æ„æ€";
quizQuestion.textContent = `æç¤ºï¼ˆæ—¥æ–‡ï¼‰ï¼š${jpDisplay}`;

options.forEach((item, idx) => {
const btn = document.createElement("button");
btn.className = "quiz-option";
btn.textContent = item.zh;
btn.addEventListener("click", () => handleAnswer(idx));
quizOptionsEl.appendChild(btn);
});
}
return;
}

// ===== å–®å­—æ¸¬é©—ï¼ˆmeaningï¼‰ï¼šå¹³ï¼ç‰‡å‡å vs å…¶ä»–å–®å…ƒä¸ä¸€æ¨£ =====
quizPlayAudioWrap.style.display = "none";

if (isKanaUnit) {
// å¹³å‡åï¼ç‰‡å‡åï¼šæç¤ºï¼è®€éŸ³ï¼Œé¸é …ï¼å‡åï¼ˆå’Œä½ ä¹‹å‰è¦æ±‚ä¸€è‡´ï¼‰
quizLabel.textContent = "å–®å­—æ¸¬é©—ï¼šè«‹é¸å‡ºæ­£ç¢ºçš„å‡å" + rowHint;
quizQuestion.textContent = `æç¤ºï¼šè®€éŸ³ ${correctItem.romaji}`;

options.forEach((item, idx) => {
const btn = document.createElement("button");
btn.className = "quiz-option";
btn.textContent = item.jp;
btn.addEventListener("click", () => handleAnswer(idx));
quizOptionsEl.appendChild(btn);
});
} else {
// å…¶ä»–å–®å…ƒï¼šéš¨æ©Ÿæ–¹å‘ï¼šä¸­æ–‡â†’æ—¥æ–‡ æˆ– æ—¥æ–‡â†’ä¸­æ–‡
const direction = Math.random() < 0.5 ? "zh-to-jp" : "jp-to-zh";

if (direction === "zh-to-jp") {
// æç¤ºä¸­æ–‡ â†’ é¸æ—¥æ–‡
quizLabel.textContent = "å–®å­—æ¸¬é©—ï¼šè«‹é¸å‡ºå°æ‡‰çš„æ—¥æ–‡";
quizQuestion.textContent = `æç¤ºï¼ˆä¸­æ–‡ï¼‰ï¼š${correctItem.zh}`;

options.forEach((item, idx) => {
const btn = document.createElement("button");
btn.className = "quiz-option";
const disp = item.jp_kanji || item.jp;
btn.textContent = disp;
btn.addEventListener("click", () => handleAnswer(idx));
quizOptionsEl.appendChild(btn);
});
} else {
// æç¤ºæ—¥æ–‡ â†’ é¸ä¸­æ–‡
quizLabel.textContent = "å–®å­—æ¸¬é©—ï¼šè«‹é¸å‡ºæ­£ç¢ºçš„ä¸­æ–‡æ„æ€";
quizQuestion.textContent = `æç¤ºï¼ˆæ—¥æ–‡ï¼‰ï¼š${jpDisplay}`;

options.forEach((item, idx) => {
const btn = document.createElement("button");
btn.className = "quiz-option";
btn.textContent = item.zh;
btn.addEventListener("click", () => handleAnswer(idx));
quizOptionsEl.appendChild(btn);
});
}
}
}

function handleAnswer(index) {
const optionButtons = quizOptionsEl.querySelectorAll(".quiz-option");
optionButtons.forEach((btn, i) => {
btn.disabled = true;
if (i === currentAnswerIndex) {
btn.classList.add("correct");
}
});

const unitKey = quizUnitSelect.value;
const jpDisplay = currentQuestionItem.jp_kanji || currentQuestionItem.jp;

if (index === currentAnswerIndex) {
quizScore++;
quizScoreEl.textContent = quizScore;
let msg = "âœ… ç­”å°äº†ï¼";

// éŒ¯é¡Œæœ¬è£œå¼·æ¨¡å¼ï¼šåœ¨éŒ¯é¡Œæœ¬å–®å…ƒç­”å°ï¼Œå°±æŠŠè©²é¡Œç§»é™¤
if (unitKey === "wrongbook") {
removeFromWrongBook(currentQuestionItem);
if (currentUnit === "wrongbook") {
renderUnit("wrongbook");
}
msg += "ï¼ˆæ­¤é¡Œå·²å¾éŒ¯é¡Œæœ¬ç§»é™¤ï¼‰";
}

quizFeedbackEl.textContent = msg;
quizFeedbackEl.classList.add("correct");
} else {
optionButtons[index].classList.add("incorrect");
quizFeedbackEl.textContent =
`âŒ ç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${jpDisplay}ï¼ˆ${currentQuestionItem.romaji}ï¼‰ï¼Œæ„æ€æ˜¯ã€Œ${currentQuestionItem.zh}ã€ã€‚`;
quizFeedbackEl.classList.add("incorrect");

addToWrongBook(currentQuestionItem);
if (currentUnit === "wrongbook") {
renderUnit("wrongbook");
}
}

if (autoNextCheckbox.checked) {
setTimeout(() => {
generateQuestion();
}, 900);
}
}

startQuizBtn.addEventListener("click", () => {
generateQuestion();
});
});
</script>
</body>
</html>
